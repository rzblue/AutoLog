package autolog.generate.out;

import edu.wpi.first.math.geometry.Pose2d;
import edu.wpi.first.math.geometry.Pose3d;
import edu.wpi.first.math.geometry.Rotation2d;
import edu.wpi.first.math.geometry.Rotation3d;
import edu.wpi.first.math.geometry.Translation2d;
import edu.wpi.first.math.geometry.Translation3d;
import edu.wpi.first.networktables.NTSendable;
import edu.wpi.first.networktables.NetworkTable;
import edu.wpi.first.networktables.NetworkTableInstance;
import edu.wpi.first.util.datalog.*;
import edu.wpi.first.networktables.*;
import edu.wpi.first.util.sendable.Sendable;
import edu.wpi.first.util.sendable.SendableBuilder;
import edu.wpi.first.wpilibj.DataLogManager;
import edu.wpi.first.wpilibj.smartdashboard.SendableBuilderImpl;
import edu.wpi.first.wpilibj.smartdashboard.SmartDashboard;
import java.util.function.*;

import java.util.Collection;
import java.util.HashMap;
import java.util.LinkedHashSet;
import java.util.Map;
import java.util.function.Supplier;

import autolog.logEntries.nt.Pose2dEntry;
import autolog.logEntries.nt.Pose3dEntry;
import autolog.logEntries.nt.Rotation2dEntry;
import autolog.logEntries.nt.Rotation3dEntry;
import autolog.logEntries.nt.Translation2dPublisher;
import autolog.logEntries.nt.Translation3dEntry;
import edu.wpi.first.wpilibj.Timer;

public class NTLogger {
    public interface NTRunnable extends LongConsumer {
        void close();
    }
    private NTLogger() {}

    private static NTRunnable field(LongConsumer run, Runnable close) {
        return new NTRunnable() {
            @Override
            public void accept(long timestamp) {
                run.accept(timestamp);
            }
            @Override
            public void close() {
                close.run();
            }
        };
    }
    private static final Map<String, NTRunnable> ntMap = new HashMap<>();
    private static final Collection<SendableBuilder> sendables = new LinkedHashSet<>();
    private static final NetworkTableInstance table = NetworkTableInstance.getDefault();

    {%for t in types%}
    public static void put(String entryName, {{t.java.ValueType}} value) {
        var topic = table.get{{t.TypeName}}Topic(entryName);
        {%if t.TypeName == 'Raw'%}
        var publisher = topic.publish("raw");
        {%else%}
        var publisher = topic.publish();{%endif%}
        topic.setRetained(true);
        publisher.set(value);
        publisher.close(); 
    }

    public static void add{{t.TypeName}}(String entryName, Supplier<{{t.java.Supplier}}> valueSupplier) {
        var topic = table.get{{t.TypeName}}Topic(entryName);
        {%if t.TypeName == 'Raw'%}
        var publisher = topic.publish("raw");
        {%else%}
        var publisher = topic.publish();
        {%endif%}
        ntMap.put(entryName, field((timestamp)->publisher.set(valueSupplier.get(), timestamp), publisher::close));
    }
    {%endfor%}

    // public static void put(String entryName, Translation2d value) {
    //     var topic = table.getDoubleArrayTopic(entryName);
    //     topic.setRetained(true);
    //     var publisher = new Translation2dPublisher(topic);
    //     publisher.set(value);
    //     publisher.close();
    // }


    public static void addTranslation2d(String entryName, Supplier<Translation2d> valueSupplier) {
        //ntMap.put(new Translation2dPublisher(table.getDoubleArrayTopic(entryName)), valueSupplier);
    }

    public static void addTranslation3d(String entryName, Supplier<Translation3d> valueSupplier) {
        //ntMap.put(new Translation3dPublisher(table, entryName), valueSupplier);
    }

    public static void addRotation2d(String entryName, Supplier<Rotation2d> valueSupplier) {
        //ntMap.put(new Rotation2dPublisher(table, entryName), valueSupplier);
    }

    public static void addRotation3d(String entryName, Supplier<Rotation3d> valueSupplier) {
        //ntMap.put(new Rotation3dPublisher(table, entryName), valueSupplier);
    }

    public static void addPose2d(String entryName, Supplier<Pose2d> valueSupplier) {
        //ntMap.put(new Pose2dEntry(table, entryName), valueSupplier);
    }

    public static void addPose3d(String entryName, Supplier<Pose3d> valueSupplier) {
        //ntMap.put(new Pose3dPublisher(table, entryName), valueSupplier);
    }

    public static void addCustom(Publisher entry, Supplier<?> valueSupplier) {
        //ntMap.put(entry, valueSupplier);
    }

    public static void addNetworkTable(NetworkTable table) {
        // NetworkTableInstance.getDefault()
        //     .startEntryDataLog(table, table.getPath(), table.getPath());
    }

    public static void addNetworkTable(NetworkTable table, String dlPath) {
        // NetworkTableInstance.getDefault()
        //     .startEntryDataLog(table, table.getPath(), dlPath);
    }

    public static void addSendable(Sendable sendable, String pathPrefix, String name) {
        String prefix;
        if (!pathPrefix.endsWith("/")) {
            prefix = pathPrefix + "/" + name + "/";
        } else {
            prefix = pathPrefix + name + "/";
        }
        var builder = new SendableBuilderImpl();
        builder.setTable(table.getTable(prefix));
        sendable.initSendable(builder);
        builder.startListeners();
        table.getTable(prefix).getEntry(".controllable").setBoolean(false);
        sendables.add(builder);
    }

    public static void update() {
        long timestamp = (long) (Timer.getFPGATimestamp() * 1e6);
        for (Map.Entry<String, NTRunnable> entry : ntMap.entrySet()) {
            var key = entry.getKey();
            var val = entry.getValue();
            //could do `key.kDatatype` and compare using that
            //but supposedly this is comparable
            val.accept(timestamp);
        }
        //sendables.forEach(SendableBuilder::update);
    }
}